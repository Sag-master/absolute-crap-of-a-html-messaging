<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supabase Dark Chat with Servers</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    background: #121212; 
    color: #e0e0e0; 
    padding: 20px; 
  }
  #chat { 
    max-width: 600px; 
    margin: auto; 
    background: #1e1e1e; 
    padding: 15px; 
    height: 60vh; 
    overflow-y: auto; 
    border-radius: 8px; 
  }
  .msg { 
    margin-bottom: 10px; 
    border-bottom: 1px solid #333; 
    padding: 5px; 
  }
  .msg img { 
    max-width: 100%; 
    border-radius: 5px; 
    margin-top: 5px; 
  }
  input, button { 
    padding: 8px; 
    border-radius: 5px; 
    border: none; 
    outline: none; 
  }
  input { background: #2c2c2c; color: #e0e0e0; flex: 1; }
  button { background: #3a86ff; color: white; cursor: pointer; }
  button:hover { background: #2e6edc; }
  #controls, #nicknameRoom { 
    max-width: 600px; 
    margin: 10px auto; 
    display: flex; 
    gap: 5px; 
  }
</style>
</head>
<body>

<div id="nicknameRoom">
  <input type="text" id="nickname" placeholder="Enter nickname..." maxlength="20">
  <input type="text" id="room" placeholder="Enter server/room..." maxlength="20" value="general">
</div>

<div id="chat"></div>

<div id="controls">
  <input type="text" id="textInput" placeholder="Type a message..." style="flex: 1;">
  <input type="file" id="fileInput" accept="image/*">
  <button id="sendBtn">Send</button>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// ðŸ”´ REPLACE THESE WITH YOUR SUPABASE CONFIG ðŸ”´
const SUPABASE_URL = "https://fdyfhnjuaxuahzkdebjg.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_w5x7cRBw7v4Wr-zhvOlN7w_UYhzlzuw";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const chatDiv = document.getElementById("chat");
const textInput = document.getElementById("textInput");
const fileInput = document.getElementById("fileInput");
const sendBtn = document.getElementById("sendBtn");
const nicknameInput = document.getElementById("nickname");
const roomInput = document.getElementById("room");

let currentRoom = roomInput.value.trim() || 'general';
let subscription = null;

// Display message in chat
function appendMessage(msg) {
  const div = document.createElement("div");
  div.className = "msg";
  div.innerHTML = `<strong>${msg.username || "Anon"}:</strong> ${msg.text || ""}`;
  if (msg.image_path) {
    const img = document.createElement("img");
    const url = supabase.storage.from("chat-images").getPublicUrl(msg.image_path).publicURL;
    img.src = url;
    div.appendChild(img);
  }
  chatDiv.appendChild(div);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

// Load messages for the room
async function loadMessages() {
  const { data } = await supabase
    .from("messages")
    .select("*")
    .eq("room", currentRoom)
    .order("created_at", { ascending: true });
  chatDiv.innerHTML = "";
  data.forEach(appendMessage);
}

// Listen for real-time messages in current room
function subscribeRoom() {
  if (subscription) supabase.removeSubscription(subscription);
  subscription = supabase
    .from(`messages:room=eq.${currentRoom}`)
    .on("INSERT", payload => appendMessage(payload.new))
    .subscribe();
}

// Switch rooms
roomInput.addEventListener('change', () => {
  currentRoom = roomInput.value.trim() || 'general';
  loadMessages();
  subscribeRoom();
});

// Initial load
loadMessages();
subscribeRoom();

sendBtn.onclick = async () => {
  const text = textInput.value.trim();
  const file = fileInput.files[0];
  const nickname = nicknameInput.value.trim() || "Anon";
  const room = currentRoom;

  if (!text && !file) return;

  let image_path = null;
  if (file) {
    const filename = Date.now() + "_" + file.name;
    const { error } = await supabase.storage.from("chat-images").upload(filename, file);
    if (error) { alert("Image upload failed"); return; }
    image_path = filename;
  }

  await supabase.from("messages").insert({ username: nickname, text, image_path, room });

  textInput.value = "";
  fileInput.value = "";
};
</script>

</body>
</html>
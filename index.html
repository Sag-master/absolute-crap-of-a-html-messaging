<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supabase Image Chat</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f7f7f7;
    padding: 20px;
  }
  #chat {
    max-width: 600px;
    margin: auto;
    background: white;
    padding: 15px;
    height: 70vh;
    overflow-y: auto;
    border-radius: 8px;
  }
  .msg {
    margin-bottom: 10px;
    border-bottom: 1px solid #ddd;
    padding: 5px;
  }
  .msg img {
    max-width: 100%;
    border-radius: 5px;
    margin-top: 5px;
  }
  #controls {
    max-width: 600px;
    margin: 10px auto;
    display: flex;
    gap: 5px;
  }
</style>
</head>
<body>

<div id="chat"></div>

<div id="controls">
  <input type="text" id="textInput" placeholder="Type a message..." style="flex: 1;">
  <input type="file" id="fileInput" accept="image/*">
  <button id="sendBtn">Send</button>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // ====== REPLACE THESE WITH YOUR SUPABASE CONFIG ======
  const SUPABASE_URL = "https://jbqgxmuemlufrnzuqsmx.supabase.com";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpicWd4bXVlbWx1ZnJuenVxc214Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNTU4NzYsImV4cCI6MjA4NzczMTg3Nn0.9O72cxbWoW2neWPY6SGRmfI232J3IUH8oVNaQFkxXzc;"
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  // =====================================================

  const chatDiv = document.getElementById("chat");
  const textInput = document.getElementById("textInput");
  const fileInput = document.getElementById("fileInput");
  const sendBtn = document.getElementById("sendBtn");

  // Helper to display a message
  function appendMessage(msg) {
    const div = document.createElement("div");
    div.className = "msg";

    div.innerHTML = `<strong>${msg.username || "Anon"}:</strong> ${msg.text || ""}`;

    if (msg.image_path) {
      const img = document.createElement("img");
      // Generate public URL
      const url = supabase.storage
        .from("chat-images")
        .getPublicUrl(msg.image_path).publicURL;
      img.src = url;
      div.appendChild(img);
    }
    chatDiv.appendChild(div);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  // Load existing messages
  async function loadMessages() {
    const { data } = await supabase
      .from("messages")
      .select("*")
      .order("created_at", { ascending: true });

    chatDiv.innerHTML = "";
    data.forEach(appendMessage);
  }

  loadMessages();

  // Listen for real-time new messages
  supabase
    .from("messages")
    .on("INSERT", payload => appendMessage(payload.new))
    .subscribe();

  sendBtn.onclick = async () => {
    const text = textInput.value.trim();
    const file = fileInput.files[0];
    if (!text && !file) return;

    let image_path = null;

    // Upload image if selected
    if (file) {
      const filename = Date.now() + "_" + file.name;
      const { error } = await supabase.storage
        .from("chat-images")
        .upload(filename, file);

      if (error) {
        alert("Image upload failed");
        return;
      }
      image_path = filename;
    }

    await supabase
      .from("messages")
      .insert({ username: "Anon", text, image_path });

    textInput.value = "";
    fileInput.value = "";
  };
</script>

</body>
</html>
